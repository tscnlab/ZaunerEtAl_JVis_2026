---
title: "Flowchart"
editor: visual
mermaid-format: png
---

```{mermaid}
%%| fig-width: 9
%%| fig-cap: "Pre-processing in supplement"
%%| label: fig-fc_supplement

flowchart TD

classDef input fill:#f7f7f7,stroke:#2f3d4a,color:#0f1a22,stroke-width:1px;
classDef process fill:#ffffff,stroke:#2f3d4a,color:#0f1a22,stroke-width:1px;
classDef output fill:#eef2f7,stroke:#2f3d4a,color:#0f1a22,stroke-width:1px;

%% ===== Raw inputs =====
RAW_CC[(Raw Clouclip file)]:::input
RAW_VEET[(Raw VEET file)]:::input

%% ===== Clouclip preprocessing =====
CC_IMP[Import 
Clouclip data]:::process
CC_QC[Inspect data, 
check for gaps and 
irregular data]:::process
CC_REG[Regularize timestamps and handle gaps]:::process
CC_VIS[Visualize cleaned 
Clouclip data]:::process

RAW_CC --> Clouclip
subgraph Clouclip[**Light and distance**]
CC_IMP --> CC_QC
CC_QC --> CC_REG
CC_REG --> CC_VIS
end

%% ===== VEET ALS light preprocessing =====
ALS_IMP[Import VEET 
*ALS* 
light modality]:::process
ALS_QC[Inspect, adjust interval, handle gaps, remove high missing days]:::process
IMU_IMP[Import VEET *IMU* actigraphy modality]:::process
IMU_NONWEAR[Detect **non-wear** using activity rules]:::process
ALS_NONWEAR[Add, label and visualize 
**non-wear**]:::process
ALS_CLEAN[Remove **non-wear** observations]:::process

RAW_VEET --> ALS_IMP
RAW_VEET --> IMU_IMP
subgraph Light[**Ambient light**]
ALS_IMP --> ALS_QC
ALS_QC --> ALS_NONWEAR
IMU_IMP --> IMU_NONWEAR
IMU_NONWEAR --> ALS_NONWEAR
ALS_NONWEAR --> ALS_CLEAN
end

%% ===== VEET spectral preprocessing =====
SPEC_IMP[Import VEET 
*PHO* 
spectral channels]:::process
SPEC_NORM[Normalize spectral channels by gain and integration time]:::process
SPEC_CLEAN[Inspect, adjust interval, handle gaps, remove high missing days]:::process
SPEC_CALfile[(Calibration matrix)]:::input
SPEC_CAL[Import calibration matrix]:::process
SPEC_RECON[Reconstruct and visualize spectra, 
calculate illuminance]:::process

RAW_VEET --> SPEC_IMP
subgraph Spectrum[**Spectral data**]
SPEC_IMP --> SPEC_NORM
SPEC_NORM --> SPEC_CLEAN
SPEC_CLEAN --> SPEC_RECON
SPEC_CALfile --> SPEC_CAL
SPEC_CAL --> SPEC_RECON
end

%% ===== VEET distance preprocessing =====
TOF_IMP[Import VEET distance 
*TOF* 
modality]:::process
TOF_QC[Inspect, adjust interval, handle gaps, remove high missing days]:::process
TOF_PIV[Pivot from *wide* to *long* format and label spatial position]:::process
TOF_NONWEAR[Add, label and remove **non-wear**]:::process

IMU_NONWEAR -.-> TOF_NONWEAR
RAW_VEET --> Distance
subgraph Distance[**Spatial distance**]
TOF_IMP --> TOF_QC
TOF_QC --> TOF_PIV
TOF_PIV --> TOF_NONWEAR
end
%% ===== Save outputs =====
SAVE[(Save cleaned datasets)]:::input

CC_VIS -- Cleaned Clouclip dataset **dataCC** --> SAVE
ALS_CLEAN -- Cleaned VEET ALS dataset **dataVEET** --> SAVE
SPEC_RECON -- Cleaned VEET spectral dataset **dataVEET2** --> SAVE
TOF_NONWEAR -- Cleaned VEET distance dataset **dataVEET3** --> SAVE

class Clouclip,Distance,Spectrum,Light output;
```

```{mermaid}
%%| fig-cap: "Analysis steps in main text"
flowchart LR

%% ===== Clean inputs =====
CC[(dataCC: Clouclip distance and light)]
ALS[(dataVEET: ALS illuminance)]
SPEC[(dataVEET2: reconstructed spectra)]
TOF[(dataVEET3: TOF distance grid)]

classDef input fill:#f7f7f7,stroke:#2f3d4a,color:#0f1a22,stroke-width:1px;
classDef process fill:#ffffff,stroke:#2f3d4a,color:#0f1a22,stroke-width:1px;
classDef output fill:#eef2f7,stroke:#2f3d4a,color:#0f1a22,stroke-width:1px;

class CC,ALS,SPEC,TOF input;

%% ===== Working distance =====
subgraph DIST[**Working distance metrics**]
  D_ALIGN[Align to 5 s grid\nmask non-wear]:::process
  D_RANGE[Durations within distance bands\nnear, intermediate, far]:::process
  D_EP[Continuous near-work episodes\nwear coverage]:::process
  D_BREAKS[Visual breaks from near work\nfrequency and % time]:::process
  D_SPATIAL[Spatial distribution from TOF grid\nangles and positions]:::process
end

CC --> D_ALIGN
TOF --> D_ALIGN
D_ALIGN --> D_RANGE
D_RANGE --> D_EP
D_EP --> D_BREAKS
TOF --> D_SPATIAL

%% ===== Illuminance exposure =====
subgraph LIGHT[**Illuminance exposure**]
  L_ALIGN[Aggregate to 5 s\ncontextualize photoperiod]:::process
  L_MEAN[Average daily illuminance\nweekdays vs weekends]:::process
  L_THRESH[Durations above lux thresholds\noutdoor vs indoor]:::process
  L_TRANS[Indoor to outdoor transitions\ncounts and timings]:::process
  L_BRIGHT[Longest and cumulative bright light\nperiods across days]:::process
end

CC --> L_ALIGN
ALS --> L_ALIGN
L_ALIGN --> L_MEAN
L_ALIGN --> L_THRESH
L_ALIGN --> L_TRANS
L_ALIGN --> L_BRIGHT

%% ===== Spectral metrics =====
subgraph SPECAN[**Spectral characteristics**]
  S_PREP[5 min aggregation\ngain-normalized spectra]:::process
  S_RATIO[Short- vs long-wavelength ratios]:::process
  S_MDER[Melanopic daylight efficacy ratio]:::process
  S_TOD[Short-wavelength exposure\nmorning, hourly profile, photoperiod]:::process
end

SPEC --> S_PREP
S_PREP --> S_RATIO
S_PREP --> S_MDER
S_PREP --> S_TOD

%% ===== Integration and reporting =====
subgraph REPORT[**Integration and reporting**]
  MERGE[Optional merge across modalities\njoin_datasets]:::process
  TABLES[Summary tables for manuscript]:::output
  FIGS[Plots of distance, light, spectrum metrics]:::output
end

D_BREAKS --> MERGE
D_SPATIAL --> MERGE
L_BRIGHT --> MERGE
S_TOD --> MERGE
MERGE --> TABLES
MERGE --> FIGS
```









